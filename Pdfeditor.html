<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DailyTools4You – Pro PDF Tools</title>

<!-- ====== Styles (Dark, App-like, Responsive) ====== -->
<style>
  :root{
    --bg:#0f0f1e; --bg2:#151530; --card:#1b1b3a;
    --accent:#9c27b0; --accent2:#7b1fa2; --accent3:#ba68c8;
    --txt:#fff; --muted:#b8bcc8; --ok:#4caf50; --err:#ff5252;
    --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--txt); min-height:100vh; display:flex; flex-direction:column}
  header{padding:28px 16px; background:var(--bg2); box-shadow:var(--shadow)}
  .wrap{max-width:1200px; margin:0 auto; padding:0 16px}
  h1{margin:0 0 6px; font-size:28px; background:linear-gradient(135deg,#4a148c,#9c27b0); -webkit-background-clip:text; background-clip:text; color:transparent}
  .tag{color:var(--muted); font-size:14px}
  main{flex:1; padding:22px 0 32px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px}
  .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
  .card h2{margin:0 0 10px; font-size:18px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{border:0; background:linear-gradient(135deg,#7b1fa2,#ba68c8); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer}
  .btn.secondary{background:#2a2a52}
  .btn.danger{background:#7b1f2f}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  input[type="text"], input[type="number"], select{background:#161633; color:#fff; border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px; width:100%}
  input[type="range"]{width:100%}
  input[type="color"]{width:48px; height:36px; padding:0; border-radius:8px; background:#161633; border:1px solid rgba(255,255,255,.1)}
  .pill{display:inline-flex; align-items:center; gap:8px; background:#131333; border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:999px; font-size:12px}
  .muted{color:var(--muted); font-size:12px}
  .thumbs{display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px; margin-top:12px}
  .thumb{position:relative; border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:hidden; background:#0d0d20}
  .thumb canvas{display:block; width:100%}
  .thumb input[type="checkbox"]{position:absolute; top:6px; left:6px; transform:scale(1.2)}
  .list{margin:8px 0; display:flex; flex-direction:column; gap:8px}
  .item{display:flex; justify-content:space-between; gap:10px; align-items:center; background:#161633; border:1px solid rgba(255,255,255,.08); padding:10px; border-radius:10px}
  .handle{cursor:grab}
  .grow{flex:1}
  footer{padding:26px 16px; background:var(--bg2); text-align:center; border-top:1px solid rgba(255,255,255,.06)}
  .donate{display:inline-block; padding:12px 22px; border-radius:999px; font-weight:800; text-decoration:none; color:#fff; background:linear-gradient(135deg,#ff9a00,#ff5722,#e91e63); box-shadow:0 10px 28px rgba(233,30,99,.35)}
  .note{margin-top:10px; color:var(--muted); font-size:13px}
  .hr{height:1px; background:rgba(255,255,255,.06); margin:12px 0}
  .opt-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px}
  .preview{border:1px dashed rgba(255,255,255,.2); border-radius:12px; padding:10px; overflow:auto; max-height:55vh}
  .inline{display:inline-flex; align-items:center; gap:8px}
  .small{font-size:12px}

  /* Mobile tweaks */
  @media (max-width: 600px){
    h1{font-size:24px}
    .preview{max-height:45vh}
    .thumbs{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>DailyTools4You – Pro PDF Tools</h1>
    <div class="tag">Merge, split, compress, watermark, and edit text — all in your browser.</div>
  </div>
</header>

<main>
  <div class="wrap grid">

    <!-- ========== MERGE ========== -->
    <section class="card" id="merge-card">
      <h2>Merge PDFs</h2>
      <div class="row">
        <input type="file" id="merge-input" multiple accept="application/pdf" />
        <button class="btn" id="merge-add">Add Files</button>
        <button class="btn secondary" id="merge-clear">Clear</button>
      </div>
      <div class="hr"></div>
      <div class="list" id="merge-list"></div>
      <div class="row">
        <span class="muted">Drag the ⠿ handle to reorder. Remove unwanted files.</span>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="merge-run">Merge & Open in New Tab</button>
      </div>
      <div class="note">Output opens in a new tab (combined.pdf).</div>
    </section>

    <!-- ========== SPLIT ========== -->
    <section class="card" id="split-card">
      <h2>Split PDF</h2>
      <div class="row">
        <input type="file" id="split-input" accept="application/pdf" />
        <span class="pill">Tip: Select pages by thumbnail or enter ranges</span>
      </div>
      <div class="opt-grid" style="margin-top:8px">
        <div>
          <label class="small">Page ranges (e.g., 1-3,5,7)</label>
          <input type="text" id="split-ranges" placeholder="Leave empty to use checkboxes" />
        </div>
        <div>
          <label class="small">Open as</label>
          <select id="split-mode">
            <option value="single">One PDF with selected pages</option>
            <option value="separate">Separate PDFs per page</option>
          </select>
        </div>
      </div>
      <div class="hr"></div>
      <div class="preview" id="split-preview"></div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="split-run">Split & Open in New Tab</button>
      </div>
    </section>

    <!-- ========== COMPRESS ========== -->
    <section class="card" id="compress-card">
      <h2>Compress PDF (Rasterize)</h2>
      <div class="row">
        <input type="file" id="compress-input" accept="application/pdf" />
      </div>
      <div class="opt-grid" style="margin-top:8px">
        <div>
          <label class="small">Quality (JPEG)</label>
          <input type="range" id="compress-quality" min="0.2" max="0.95" step="0.05" value="0.6" />
          <div class="inline small"><span>Lower = smaller file, but blurrier</span></div>
        </div>
        <div>
          <label class="small">Max width (px)</label>
          <input type="number" id="compress-width" value="1200" min="600" max="2400" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="compress-run">Compress & Open in New Tab</button>
      </div>
      <div class="note">This converts each page to an image to shrink file size (best for scans). Text becomes rasterized.</div>
    </section>

    <!-- ========== WATERMARK ========== -->
    <section class="card" id="watermark-card">
      <h2>Add Watermark (Text)</h2>
      <div class="row">
        <input type="file" id="watermark-input" accept="application/pdf" />
      </div>
      <div class="opt-grid" style="margin-top:8px">
        <div>
          <label class="small">Watermark text</label>
          <input type="text" id="wm-text" placeholder="CONFIDENTIAL" value="CONFIDENTIAL" />
        </div>
        <div>
          <label class="small">Font size</label>
          <select id="wm-size">
            <option>12</option><option>16</option><option selected>32</option>
            <option>48</option><option>64</option><option>96</option><option>128</option>
          </select>
        </div>
        <div>
          <label class="small">Opacity</label>
          <input type="range" id="wm-opacity" min="0.1" max="1" step="0.05" value="0.25" />
        </div>
        <div>
          <label class="small">Rotation (deg)</label>
          <select id="wm-rot">
            <option value="-90">-90°</option>
            <option value="-60">-60°</option>
            <option value="-45">-45°</option>
            <option value="-30" selected>-30°</option>
            <option value="0">0°</option>
            <option value="30">30°</option>
            <option value="45">45°</option>
            <option value="60">60°</option>
            <option value="90">90°</option>
          </select>
        </div>
        <div>
          <label class="small">Position</label>
          <select id="wm-pos">
            <option value="center">Center</option>
            <option value="topleft">Top Left</option>
            <option value="topright">Top Right</option>
            <option value="bottomleft">Bottom Left</option>
            <option value="bottomright">Bottom Right</option>
            <option value="click">Click on preview</option>
          </select>
        </div>
        <div>
          <label class="small">Color</label>
          <input type="color" id="wm-color" value="#ffffff" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="preview" id="wm-preview"></div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="watermark-run">Apply & Open in New Tab</button>
      </div>
      <div class="note">Click-to-place works when “Position = Click on preview”.</div>
    </section>

    <!-- ========== ADD TEXT ========== -->
    <section class="card" id="text-card">
      <h2>Add Text (Annotate)</h2>
      <div class="row">
        <input type="file" id="text-input" accept="application/pdf" />
      </div>
      <div class="opt-grid" style="margin-top:8px">
        <div>
          <label class="small">Text</label>
          <input type="text" id="text-string" placeholder="Type something…" />
        </div>
        <div>
          <label class="small">Font size</label>
          <select id="text-size">
            <option>12</option><option>16</option><option selected>18</option>
            <option>24</option><option>32</option><option>48</option><option>64</option>
          </select>
        </div>
        <div>
          <label class="small">Color</label>
          <input type="color" id="text-color" value="#ff4081" />
        </div>
        <div>
          <label class="small">Apply to</label>
          <select id="text-scope">
            <option value="click">Click on preview</option>
            <option value="allpages">All pages (top-left)</option>
            <option value="firstpage">First page (top-left)</option>
          </select>
        </div>
        <div>
          <label class="small">Rotation (deg)</label>
          <select id="text-rot">
            <option value="0" selected>0°</option>
            <option value="-45">-45°</option>
            <option value="-30">-30°</option>
            <option value="30">30°</option>
            <option value="45">45°</option>
            <option value="90">90°</option>
          </select>
        </div>
      </div>
      <div class="hr"></div>
      <div class="preview" id="text-preview"></div>
      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="text-run">Apply & Open in New Tab</button>
      </div>
    </section>

  </div>
</main>

<footer>
  <a class="donate" href="https://buymeacoffee.com/dailytools4you" target="_blank" rel="noopener">☕ If you find this useful, support me with 1$</a>
  <div class="note">All processing happens in your browser. Your files never leave your device.</div>
</footer>

<!-- ====== Libraries: PDF.js (for preview) & pdf-lib (for edits) ====== -->
<!-- PDF.js (build + worker) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
</script>

<!-- pdf-lib -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<!-- ====== App Logic ====== -->
<script>
  // Shortcuts
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // Convert HEX to pdf-lib rgb
  const toRgb = (hex) => {
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex.trim());
    if (!m) return {r:1,g:0,b:0};
    return { r: parseInt(m[1],16)/255, g: parseInt(m[2],16)/255, b: parseInt(m[3],16)/255 };
  };

  // Open bytes as PDF in a new tab
  const openPdfInNewTab = (bytes) => {
    const blob = new Blob([bytes], {type:"application/pdf"});
    const url = URL.createObjectURL(blob);
    // Open in new tab from user gesture context (button click)
    const tab = window.open(url, "_blank");
    // Clean up later
    setTimeout(()=> URL.revokeObjectURL(url), 60_000);
    if (!tab) alert("Popup blocked. Please allow pop-ups for this site to preview the PDF.");
  };

  const readAsArrayBuffer = (file) =>
    new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsArrayBuffer(file); });

  /* ---------- MERGE ---------- */
  (function initMerge(){
    const input = $('#merge-input');
    const list = $('#merge-list');
    const addBtn = $('#merge-add');
    const clearBtn = $('#merge-clear');
    const runBtn = $('#merge-run');
    let files = [];

    addBtn.addEventListener('click', ()=> input.click());
    input.addEventListener('change', () => {
      files = files.concat(Array.from(input.files));
      render();
      input.value = "";
    });
    clearBtn.addEventListener('click', ()=> { files = []; render(); });

    function render(){
      list.innerHTML = '';
      files.forEach((f, idx) => {
        const el = document.createElement('div');
        el.className = 'item';
        el.draggable = true;
        el.innerHTML = `
          <div class="handle">⠿</div>
          <div class="grow">${f.name}</div>
          <div class="inline small"><span>${(f.size/1024/1024).toFixed(2)} MB</span></div>
          <button class="btn danger" data-i="${idx}">Remove</button>
        `;
        el.querySelector('.btn').addEventListener('click', (e)=>{
          const i = +e.currentTarget.dataset.i; files.splice(i,1); render();
        });
        // drag reorder
        el.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', idx); });
        el.addEventListener('dragover', (e)=> e.preventDefault());
        el.addEventListener('drop', (e)=>{
          e.preventDefault();
          const from = +e.dataTransfer.getData('text/plain');
          const to = idx;
          const [moved] = files.splice(from,1);
          files.splice(to,0,moved);
          render();
        });
        list.appendChild(el);
      });
    }

    runBtn.addEventListener('click', async ()=>{
      if (!files.length) { alert('Please add PDF files.'); return; }
      runBtn.disabled = true; runBtn.textContent = 'Merging…';
      try {
        const { PDFDocument } = PDFLib;
        const out = await PDFDocument.create();
        for (const f of files) {
          const bytes = new Uint8Array(await readAsArrayBuffer(f));
          const doc = await PDFDocument.load(bytes);
          const pages = await out.copyPages(doc, doc.getPageIndices());
          pages.forEach(p => out.addPage(p));
        }
        const outBytes = await out.save();
        openPdfInNewTab(outBytes);
      } catch (e) {
        console.error(e); alert('Merge failed.');
      } finally {
        runBtn.disabled = false; runBtn.textContent = 'Merge & Open in New Tab';
      }
    });
  })();

  /* ---------- SPLIT (with thumbnails & ranges) ---------- */
  (function initSplit(){
    const input = $('#split-input');
    const preview = $('#split-preview');
    const runBtn = $('#split-run');
    const rangesEl = $('#split-ranges');
    const modeEl = $('#split-mode');

    let file = null;
    let pdfjsDoc = null;
    let pageCount = 0;

    input.addEventListener('change', async ()=>{
      file = input.files[0];
      if (!file) return;
      preview.innerHTML = 'Loading preview…';
      const data = await readAsArrayBuffer(file);
      const uint8 = new Uint8Array(data);
      pdfjsDoc = await pdfjsLib.getDocument({data:uint8}).promise;
      pageCount = pdfjsDoc.numPages;
      preview.innerHTML = '';
      // Thumbnails with checkboxes
      for (let i=1;i<=pageCount;i++){
        const page = await pdfjsDoc.getPage(i);
        const viewport = page.getViewport({scale: 0.6});
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = Math.ceil(viewport.width);
        canvas.height = Math.ceil(viewport.height);
        await page.render({canvasContext: context, viewport}).promise;
        const wrap = document.createElement('label');
        wrap.className = 'thumb';
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.checked = true; cb.dataset.page = i;
        wrap.appendChild(cb);
        wrap.appendChild(canvas);
        const cap = document.createElement('div');
        cap.className='small muted';
        cap.style.position='absolute'; cap.style.right='6px'; cap.style.bottom='6px';
        cap.textContent = i;
        wrap.appendChild(cap);
        preview.appendChild(wrap);
      }
    });

    function parseRanges(rangesStr, max){
      if (!rangesStr.trim()) return null;
      const set = new Set();
      const parts = rangesStr.split(',');
      for (const p of parts){
        const seg = p.trim();
        if (!seg) continue;
        if (seg.includes('-')){
          const [a,b] = seg.split('-').map(n=>+n);
          if (isNaN(a)||isNaN(b) || a<1 || b>max || a>b) continue;
          for (let k=a;k<=b;k++) set.add(k);
        } else {
          const n = +seg;
          if (!isNaN(n) && n>=1 && n<=max) set.add(n);
        }
      }
      return Array.from(set).sort((x,y)=>x-y);
    }

    runBtn.addEventListener('click', async ()=>{
      if (!file){ alert('Upload a PDF first.'); return; }
      const srcBytes = new Uint8Array(await readAsArrayBuffer(file));
      const { PDFDocument } = PDFLib;
      const srcDoc = await PDFDocument.load(srcBytes);

      let pagesToKeep = parseRanges(rangesEl.value, srcDoc.getPageCount());
      if (!pagesToKeep){
        // use checkboxes
        pagesToKeep = $$('#split-preview input[type="checkbox"]')
          .filter(cb=>cb.checked)
          .map(cb=>+cb.dataset.page);
      }
      if (!pagesToKeep.length){ alert('Select at least one page.'); return; }

      const mode = modeEl.value;
      runBtn.disabled = true; runBtn.textContent='Splitting…';
      try {
        if (mode === 'single'){
          const out = await PDFDocument.create();
          const copied = await out.copyPages(srcDoc, pagesToKeep.map(n=>n-1));
          copied.forEach(p=> out.addPage(p));
          openPdfInNewTab(await out.save());
        } else {
          // separate files -> open each in a new tab
          for (const n of pagesToKeep){
            const out = await PDFDocument.create();
            const [pg] = await out.copyPages(srcDoc, [n-1]);
            out.addPage(pg);
            openPdfInNewTab(await out.save());
          }
        }
      } catch(e){ console.error(e); alert('Split failed.'); }
      finally { runBtn.disabled=false; runBtn.textContent='Split & Open in New Tab'; }
    });
  })();

  /* ---------- COMPRESS (rasterize pages via PDF.js -> JPEG -> pdf-lib) ---------- */
  (function initCompress(){
    const input = $('#compress-input');
    const runBtn = $('#compress-run');
    const qEl = $('#compress-quality');
    const wEl = $('#compress-width');

    runBtn.addEventListener('click', async ()=>{
      const file = input.files[0];
      if (!file){ alert('Upload a PDF first.'); return; }
      runBtn.disabled = true; runBtn.textContent='Compressing…';

      try {
        const data = new Uint8Array(await readAsArrayBuffer(file));
        const pdfjsDoc = await pdfjsLib.getDocument({data}).promise;
        const { PDFDocument } = PDFLib;
        const out = await PDFDocument.create();

        const quality = parseFloat(qEl.value);
        const maxW = Math.max(600, Math.min(2400, parseInt(wEl.value||1200,10)));

        for (let i=1; i<=pdfjsDoc.numPages; i++){
          const page = await pdfjsDoc.getPage(i);
          const viewport = page.getViewport({scale: 1.5});
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const scale = maxW / viewport.width;
          const useScale = Math.min(1.5, scale);
          const vp = page.getViewport({scale: useScale});
          canvas.width = Math.ceil(vp.width);
          canvas.height = Math.ceil(vp.height);
          await page.render({canvasContext: ctx, viewport: vp}).promise;

          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          const jpgBytes = atob(dataUrl.split(',')[1]);
          const jpgUint8 = new Uint8Array(jpgBytes.length);
          for (let j=0;j<jpgBytes.length;j++) jpgUint8[j] = jpgBytes.charCodeAt(j);

          const img = await out.embedJpg(jpgUint8);
          const p = out.addPage([img.width, img.height]);
          p.drawImage(img, {x:0, y:0, width:img.width, height:img.height});
        }

        openPdfInNewTab(await out.save());
      } catch(e){ console.error(e); alert('Compression failed.'); }
      finally { runBtn.disabled=false; runBtn.textContent='Compress & Open in New Tab'; }
    });
  })();

  /* ---------- WATERMARK (preview + click-to-place) ---------- */
  (function initWatermark(){
    const input = $('#watermark-input');
    const preview = $('#wm-preview');
    const runBtn = $('#watermark-run');
    const textEl = $('#wm-text'), sizeEl = $('#wm-size'),
          opEl = $('#wm-opacity'), rotEl = $('#wm-rot'), posEl = $('#wm-pos'),
          colorEl = $('#wm-color');

    let file = null, pdfjsDoc = null;
    let clickPositions = {}; // pageIndex -> {x,y} in PDF space

    input.addEventListener('change', async ()=>{
      file = input.files[0]; clickPositions = {};
      if (!file) return;
      preview.innerHTML = 'Loading preview…';
      const data = new Uint8Array(await readAsArrayBuffer(file));
      pdfjsDoc = await pdfjsLib.getDocument({data}).promise;
      preview.innerHTML = '';

      for (let i=1; i<=pdfjsDoc.numPages; i++){
        const page = await pdfjsDoc.getPage(i);
        const viewport = page.getViewport({scale: 0.8});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.ceil(viewport.width);
        canvas.height = Math.ceil(viewport.height);
        await page.render({canvasContext: ctx, viewport}).promise;

        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.appendChild(canvas);
        const cap = document.createElement('div');
        cap.className = 'small muted';
        cap.style.position='absolute'; cap.style.right='6px'; cap.style.bottom='6px';
        cap.textContent = `Page ${i}`;
        wrap.appendChild(cap);

        // click-to-place
        wrap.addEventListener('click', (ev)=>{
          if (posEl.value !== 'click') return;
          const rect = canvas.getBoundingClientRect();
          const cx = ev.clientX - rect.left;
          const cy = ev.clientY - rect.top;
          const viewport = page.getViewport({scale: 0.8}); // same as render
          const scaleX = (viewport.width / canvas.width);
          const scaleY = (viewport.height / canvas.height);
          const pdfX = cx * scaleX;
          const pdfY = (canvas.height - cy) * scaleY;
          clickPositions[i-1] = {x: pdfX, y: pdfY};

          const marker = document.createElement('div');
          marker.style.position='absolute'; marker.style.width='10px'; marker.style.height='10px';
          marker.style.borderRadius='50%'; marker.style.background='#ff4081';
          marker.style.left = `${cx-5}px`;
          marker.style.top = `${cy-5}px`;
          wrap.appendChild(marker);
        });

        preview.appendChild(wrap);
      }
    });

    runBtn.addEventListener('click', async ()=>{
      if (!file){ alert('Upload a PDF first.'); return; }
      runBtn.disabled = true; runBtn.textContent = 'Applying…';

      try {
        const srcBytes = new Uint8Array(await readAsArrayBuffer(file));
        const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;
        const doc = await PDFDocument.load(srcBytes);
        const helv = await doc.embedFont(StandardFonts.HelveticaBold);
        const pages = doc.getPages();

        const txt = (textEl.value || 'CONFIDENTIAL').toString();
        const size = Math.max(8, Math.min(200, parseInt(sizeEl.value||64,10)));
        const rot = degrees(parseFloat(rotEl.value||0));
        const opacity = Math.max(0.05, Math.min(1, parseFloat(opEl.value||0.25)));
        const col = toRgb(colorEl.value || '#ffffff');

        for (let i=0;i<pages.length;i++){
          const p = pages[i];
          const { width, height } = p.getSize();

          // determine coords
          let x = width/2, y = height/2, align='center';
          const pos = posEl.value;
          if (pos==='topleft'){ x = 40; y = height-60; align='left'; }
          else if (pos==='topright'){ x = width-40; y = height-60; align='right'; }
          else if (pos==='bottomleft'){ x = 40; y = 40; align='left'; }
          else if (pos==='bottomright'){ x = width-40; y = 40; align='right'; }
          else if (pos==='click' && clickPositions[i]) {
            x = clickPositions[i].x; y = clickPositions[i].y; align='left';
          }

          const textWidth = helv.widthOfTextAtSize(txt, size);
          let drawX = x;
          if (align==='center') drawX = x - textWidth/2;
          if (align==='right')  drawX = x - textWidth;

          p.drawText(txt, {
            x: drawX, y,
            size, font: helv,
            color: rgb(col.r,col.g,col.b),
            rotate: rot,
            opacity
          });
        }

        const out = await doc.save();
        openPdfInNewTab(out);
      } catch(e){ console.error(e); alert('Watermark failed.'); }
      finally { runBtn.disabled=false; runBtn.textContent='Apply & Open in New Tab'; }
    });
  })();

  /* ---------- ADD TEXT (click-to-place + scopes + color picker + rotation select) ---------- */
  (function initText(){
    const input = $('#text-input');
    const preview = $('#text-preview');
    const runBtn = $('#text-run');
    const contentEl = $('#text-string'), sizeEl = $('#text-size'),
          colorEl = $('#text-color'), scopeEl = $('#text-scope'),
          rotEl = $('#text-rot');

    let file = null, pdfjsDoc = null;
    let clicks = {}; // pageIndex -> array of {x,y,text}

    input.addEventListener('change', async ()=>{
      file = input.files[0]; clicks = {};
      if (!file) return;
      preview.innerHTML = 'Loading preview…';
      const data = new Uint8Array(await readAsArrayBuffer(file));
      pdfjsDoc = await pdfjsLib.getDocument({data}).promise;
      preview.innerHTML = '';

      for (let i=1; i<=pdfjsDoc.numPages; i++){
        const page = await pdfjsDoc.getPage(i);
        const viewport = page.getViewport({scale: 0.8});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.ceil(viewport.width);
        canvas.height = Math.ceil(viewport.height);
        await page.render({canvasContext: ctx, viewport}).promise;

        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        wrap.appendChild(canvas);
        const cap = document.createElement('div');
        cap.className='small muted';
        cap.style.position='absolute'; cap.style.right='6px'; cap.style.bottom='6px';
        cap.textContent = `Page ${i}`;
        wrap.appendChild(cap);

        wrap.addEventListener('click', (ev)=>{
          if (scopeEl.value!=='click') return;
          const txt = contentEl.value.trim();
          if (!txt){ alert('Enter text first.'); return; }
          const rect = canvas.getBoundingClientRect();
          const cx = ev.clientX - rect.left;
          const cy = ev.clientY - rect.top;
          const scaleX = viewport.width / canvas.width;
          const scaleY = viewport.height / canvas.height;
          const pdfX = cx * scaleX;
          const pdfY = (canvas.height - cy) * scaleY;
          if (!clicks[i-1]) clicks[i-1] = [];
          clicks[i-1].push({x: pdfX, y: pdfY, text: txt});
          const mark = document.createElement('div');
          mark.style.position='absolute'; mark.style.left=(cx-2)+'px'; mark.style.top=(cy-2)+'px';
          mark.style.width='6px'; mark.style.height='6px'; mark.style.borderRadius='50%'; mark.style.background='#52d1ff';
          wrap.appendChild(mark);
        });

        preview.appendChild(wrap);
      }
    });

    runBtn.addEventListener('click', async ()=>{
      if (!file){ alert('Upload a PDF first.'); return; }
      runBtn.disabled = true; runBtn.textContent='Applying…';

      try {
        const bytes = new Uint8Array(await readAsArrayBuffer(file));
        const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;
        const doc = await PDFDocument.load(bytes);
        const font = await doc.embedFont(StandardFonts.Helvetica);
        const pages = doc.getPages();

        const txt = contentEl.value.toString();
        if (!txt) { alert('Enter text.'); runBtn.disabled=false; runBtn.textContent='Apply & Open in New Tab'; return; }
        const size = Math.max(8, Math.min(200, parseInt(sizeEl.value||18,10)));
        const col = toRgb(colorEl.value||'#ff4081');
        const rot = degrees(parseFloat(rotEl.value||0));

        if (scopeEl.value === 'click'){
          for (const [idxStr, arr] of Object.entries(clicks)){
            const idx = +idxStr;
            const p = pages[idx];
            arr.forEach(pt=>{
              p.drawText(pt.text, { x: pt.x, y: pt.y, size, font, color: rgb(col.r,col.g,col.b), rotate: rot });
            });
          }
        } else if (scopeEl.value === 'allpages'){
          for (const p of pages){
            const { height } = p.getSize();
            p.drawText(txt, { x: 40, y: height-60, size, font, color: rgb(col.r,col.g,col.b), rotate: rot });
          }
        } else {
          const p = pages[0];
          const { height } = p.getSize();
          p.drawText(txt, { x: 40, y: height-60, size, font, color: rgb(col.r,col.g,col.b), rotate: rot });
        }

        openPdfInNewTab(await doc.save());
      } catch(e){ console.error(e); alert('Add Text failed.'); }
      finally { runBtn.disabled=false; runBtn.textContent='Apply & Open in New Tab'; }
    });
  })();
</script>
</body>
</html>
